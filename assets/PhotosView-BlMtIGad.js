import{r as v,l as Pe,c as A,h as Ae,z as _,B as s,R as e,J as l,al as i,Q as D,a6 as F,aC as Se,A as c,O as m,I as S,P as r,W as K,L as J}from"./vendor-Kw1AtJDw.js";import{a as U}from"./index-BfJ1v8kG.js";import{c as Te}from"./index-D5g6VmwX.js";import{E as w,c as We,d as Ne}from"./elementPlus-CHQYLhPp.js";import{_ as Ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";const qe={class:"photos-view"},je={class:"header-actions"},He={class:"stat-content"},Ke={class:"stat-info"},Je={class:"stat-number"},Oe={class:"stat-content"},Qe={class:"stat-info"},Ge={class:"stat-number"},Xe={class:"stat-content"},Ze={class:"stat-info"},et={class:"stat-number"},tt={class:"media-container"},lt={key:0,class:"empty-state"},at={key:1,class:"media-grid"},ot=["onClick"],st={class:"media-preview"},it=["src","alt"],nt={key:1,class:"video-preview"},dt=["src","alt"],rt={class:"media-overlay"},ct={class:"overlay-actions"},ut={class:"media-info"},_t={class:"media-title"},pt={class:"media-meta"},mt={class:"meta-item"},vt={class:"meta-item"},ft={class:"meta-item"},yt={key:0,class:"activity-tag"},gt={key:0,class:"file-list"},ht={class:"file-info"},wt={class:"file-name"},Vt={class:"file-size"},bt={class:"dialog-footer"},kt={key:0,class:"media-preview-container"},Ct={class:"media-display"},Ut=["src","alt"],xt=["src"],Mt={class:"media-details"},Bt={class:"comments-section"},Dt={class:"comment-input"},Ft={class:"comments-list"},Rt={class:"comment-content"},$t={class:"comment-header"},zt={class:"comment-author"},Lt={class:"comment-time"},Et={class:"comment-text"},It={__name:"PhotosView",setup(Pt){const ie=Se(),V=v([]),T=v([]),x=v(!1),W=v(!1),d=v(null),N=v(!1),Y=v(),ne=v(),O=v(!1),M=v(""),R=v(""),q=v("upload_time"),$=v(""),B=v(""),g=v([]),y=Pe({activity_id:"",title:"",description:""}),de={activity_id:[{required:!0,message:"请选择活动",trigger:"change"}],title:[{required:!0,message:"请输入文件标题",trigger:"blur"}]},Q=A(()=>{let a=V.value;if(M.value&&(a=a.filter(t=>t.activity_id===M.value)),R.value&&(a=a.filter(t=>t.media_type===R.value)),$.value){const t=$.value.toLowerCase();a=a.filter(n=>n.title&&n.title.toLowerCase().includes(t)||n.original_filename.toLowerCase().includes(t)||n.description&&n.description.toLowerCase().includes(t))}return a.sort((t,n)=>{switch(q.value){case"filename":return t.original_filename.localeCompare(n.original_filename);case"views":return n.views_count-t.views_count;default:return new Date(n.upload_time)-new Date(t.upload_time)}}),a}),re=A(()=>V.value.filter(a=>a.media_type==="photo").length),ce=A(()=>V.value.filter(a=>a.media_type==="video").length),ue=A(()=>V.value.reduce((a,t)=>a+t.views_count,0)),j=a=>Ne(a).format("YYYY-MM-DD HH:mm"),G=a=>a<1024?a+" B":a<1024*1024?(a/1024).toFixed(1)+" KB":(a/(1024*1024)).toFixed(1)+" MB",z=a=>a?a.startsWith("http")?a:`${Te.apiBaseUrl.replace("/api","")}/uploads/${a}`:"/api/placeholder/300/200",_e=()=>{y.activity_id="",y.title="",y.description="",g.value=[],x.value=!0},pe=(a,t)=>{g.value=t.map(n=>n.raw).filter(Boolean)},me=a=>a.type.startsWith("image/")||a.type.startsWith("video/")?a.size/1024/1024<10?!0:(w.error("文件大小不能超过 10MB！"),!1):(w.error("只能上传图片或视频文件！"),!1),ve=a=>{g.value.splice(a,1)},fe=async()=>{Y.value&&await Y.value.validate(async a=>{if(a&&g.value.length>0){N.value=!0;try{for(let n=0;n<g.value.length;n++){const p=g.value[n],f=new FormData;f.append("file",p),f.append("activity_id",y.activity_id),f.append("title",y.title+(g.value.length>1?` (${n+1})`:"")),f.append("description",y.description||""),await U.media.upload(f)}w.success(`成功上传 ${g.value.length} 个文件`),x.value=!1;const t=await U.media.getAll();V.value=t.data}catch(t){console.error("上传失败:",t),w.error("上传失败，请重试")}finally{N.value=!1}}})},ye=async a=>{d.value=a;try{const t=await U.media.getById(a.id);d.value=t.data;const n=await U.comments.getByMediaId(a.id);d.value.comments=n.data}catch(t){console.error("加载媒体详情失败:",t),d.value.comments=[]}W.value=!0},ge=a=>{w.info("下载功能开发中...")},he=a=>{w.info("分享功能开发中...")},we=async a=>{try{await We.confirm("确定要删除这个文件吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=V.value.findIndex(n=>n.id===a.id);t>-1&&(V.value.splice(t,1),w.success("文件删除成功"))}catch{}},Ve=async()=>{if(!B.value.trim()){w.warning("请输入评论内容");return}try{const a={content:B.value,media_item_id:d.value.id},t=await U.comments.create(a);d.value.comments||(d.value.comments=[]),d.value.comments.unshift(t.data),B.value="",w.success("评论发表成功")}catch(a){console.error("评论发表失败:",a),w.error("评论发表失败，请重试")}},be=async()=>{O.value=!0;try{const[a,t]=await Promise.all([U.activities.getAll(),U.media.getAll()]);T.value=a.data,V.value=t.data;const n=ie.query.activity;n&&(M.value=parseInt(n))}catch(a){console.error("加载数据失败:",a),w.error("加载数据失败")}finally{O.value=!1}};return Ae(()=>{be()}),(a,t)=>{var le,ae;const n=i("Upload"),p=i("el-icon"),f=i("el-button"),b=i("el-option"),L=i("el-select"),k=i("el-col"),ke=i("Search"),E=i("el-input"),X=i("el-row"),I=i("el-card"),Z=i("Picture"),H=i("VideoPlay"),ee=i("View"),Ce=i("el-empty"),Ue=i("Download"),xe=i("Share"),Me=i("Delete"),Be=i("Calendar"),De=i("User"),Fe=i("el-tag"),P=i("el-form-item"),Re=i("UploadFilled"),$e=i("el-upload"),ze=i("Close"),Le=i("el-form"),te=i("el-dialog"),C=i("el-descriptions-item"),Ee=i("el-descriptions"),Ie=i("el-avatar");return c(),_("div",qe,[s("div",je,[t[15]||(t[15]=s("h2",{class:"page-title"},"照片视频",-1)),e(f,{type:"primary",onClick:_e},{default:l(()=>[e(p,null,{default:l(()=>[e(n)]),_:1}),t[14]||(t[14]=m(" 上传文件 ",-1))]),_:1})]),e(I,{class:"filter-card"},{default:l(()=>[e(X,{gutter:16},{default:l(()=>[e(k,{span:6},{default:l(()=>[e(L,{modelValue:M.value,"onUpdate:modelValue":t[0]||(t[0]=o=>M.value=o),placeholder:"选择活动",clearable:""},{default:l(()=>[(c(!0),_(D,null,F(T.value,o=>(c(),S(b,{key:o.id,label:o.title,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(k,{span:6},{default:l(()=>[e(L,{modelValue:R.value,"onUpdate:modelValue":t[1]||(t[1]=o=>R.value=o),placeholder:"文件类型",clearable:""},{default:l(()=>[e(b,{label:"全部",value:""}),e(b,{label:"照片",value:"photo"}),e(b,{label:"视频",value:"video"})]),_:1},8,["modelValue"])]),_:1}),e(k,{span:6},{default:l(()=>[e(L,{modelValue:q.value,"onUpdate:modelValue":t[2]||(t[2]=o=>q.value=o),placeholder:"排序方式"},{default:l(()=>[e(b,{label:"最新上传",value:"upload_time"}),e(b,{label:"文件名",value:"filename"}),e(b,{label:"浏览次数",value:"views"})]),_:1},8,["modelValue"])]),_:1}),e(k,{span:6},{default:l(()=>[e(E,{modelValue:$.value,"onUpdate:modelValue":t[3]||(t[3]=o=>$.value=o),placeholder:"搜索文件...",clearable:""},{prefix:l(()=>[e(p,null,{default:l(()=>[e(ke)]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(X,{gutter:20,class:"stats-row"},{default:l(()=>[e(k,{span:8},{default:l(()=>[e(I,{class:"stat-card"},{default:l(()=>[s("div",He,[e(p,{class:"stat-icon"},{default:l(()=>[e(Z)]),_:1}),s("div",Ke,[s("div",Je,r(re.value),1),t[16]||(t[16]=s("div",{class:"stat-label"},"照片",-1))])])]),_:1})]),_:1}),e(k,{span:8},{default:l(()=>[e(I,{class:"stat-card"},{default:l(()=>[s("div",Oe,[e(p,{class:"stat-icon video"},{default:l(()=>[e(H)]),_:1}),s("div",Qe,[s("div",Ge,r(ce.value),1),t[17]||(t[17]=s("div",{class:"stat-label"},"视频",-1))])])]),_:1})]),_:1}),e(k,{span:8},{default:l(()=>[e(I,{class:"stat-card"},{default:l(()=>[s("div",Xe,[e(p,{class:"stat-icon views"},{default:l(()=>[e(ee)]),_:1}),s("div",Ze,[s("div",et,r(ue.value),1),t[18]||(t[18]=s("div",{class:"stat-label"},"总浏览",-1))])])]),_:1})]),_:1})]),_:1}),s("div",tt,[Q.value.length===0?(c(),_("div",lt,[e(Ce,{description:"暂无媒体文件"})])):(c(),_("div",at,[(c(!0),_(D,null,F(Q.value,o=>{var u;return c(),_("div",{key:o.id,class:"media-item",onClick:h=>ye(o)},[s("div",st,[o.media_type==="photo"?(c(),_("img",{key:0,src:z(o.file_path),alt:o.title,class:"media-image",onError:t[4]||(t[4]=h=>h.target.src="/api/placeholder/300/200")},null,40,it)):(c(),_("div",nt,[e(p,{class:"video-icon"},{default:l(()=>[e(H)]),_:1}),s("img",{src:z(o.file_path),alt:o.title,class:"media-image",onError:t[5]||(t[5]=h=>h.target.src="/api/placeholder/300/200")},null,40,dt)])),s("div",rt,[s("div",ct,[e(f,{circle:"",size:"small",onClick:K(h=>ge(),["stop"])},{default:l(()=>[e(p,null,{default:l(()=>[e(Ue)]),_:1})]),_:2},1032,["onClick"]),e(f,{circle:"",size:"small",onClick:K(h=>he(),["stop"])},{default:l(()=>[e(p,null,{default:l(()=>[e(xe)]),_:1})]),_:2},1032,["onClick"]),e(f,{circle:"",size:"small",type:"danger",onClick:K(h=>we(o),["stop"])},{default:l(()=>[e(p,null,{default:l(()=>[e(Me)]),_:1})]),_:2},1032,["onClick"])])])]),s("div",ut,[s("h4",_t,r(o.title||o.original_filename),1),s("div",pt,[s("span",mt,[e(p,null,{default:l(()=>[e(Be)]),_:1}),m(" "+r(j(o.upload_time)),1)]),s("span",vt,[e(p,null,{default:l(()=>[e(De)]),_:1}),m(" "+r((u=o.uploader)==null?void 0:u.full_name),1)]),s("span",ft,[e(p,null,{default:l(()=>[e(ee)]),_:1}),m(" "+r(o.views_count),1)])]),o.activity?(c(),_("div",yt,[e(Fe,{size:"small"},{default:l(()=>[m(r(o.activity.title),1)]),_:2},1024)])):J("",!0)])],8,ot)}),128))]))]),e(te,{modelValue:x.value,"onUpdate:modelValue":t[10]||(t[10]=o=>x.value=o),title:"上传文件",width:"600px","destroy-on-close":""},{footer:l(()=>[s("div",bt,[e(f,{onClick:t[9]||(t[9]=o=>x.value=!1)},{default:l(()=>[...t[21]||(t[21]=[m("取消",-1)])]),_:1}),e(f,{type:"primary",loading:N.value,disabled:g.value.length===0,onClick:fe},{default:l(()=>[m(" 上传 ("+r(g.value.length)+") ",1)]),_:1},8,["loading","disabled"])])]),default:l(()=>[e(Le,{ref_key:"uploadFormRef",ref:Y,model:y,rules:de,"label-width":"80px"},{default:l(()=>[e(P,{label:"选择活动",prop:"activity_id"},{default:l(()=>[e(L,{modelValue:y.activity_id,"onUpdate:modelValue":t[6]||(t[6]=o=>y.activity_id=o),placeholder:"请选择活动",style:{width:"100%"}},{default:l(()=>[(c(!0),_(D,null,F(T.value,o=>(c(),S(b,{key:o.id,label:o.title,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(P,{label:"文件标题",prop:"title"},{default:l(()=>[e(E,{modelValue:y.title,"onUpdate:modelValue":t[7]||(t[7]=o=>y.title=o),placeholder:"为文件起个标题"},null,8,["modelValue"])]),_:1}),e(P,{label:"文件描述"},{default:l(()=>[e(E,{modelValue:y.description,"onUpdate:modelValue":t[8]||(t[8]=o=>y.description=o),type:"textarea",rows:3,placeholder:"描述一下这个文件..."},null,8,["modelValue"])]),_:1}),e(P,{label:"选择文件",prop:"files"},{default:l(()=>[e($e,{ref_key:"uploadRef",ref:ne,class:"upload-area",drag:"","auto-upload":!1,"on-change":pe,"before-upload":me,multiple:"",accept:"image/*,video/*"},{tip:l(()=>[...t[19]||(t[19]=[s("div",{class:"el-upload__tip"}," 支持 jpg/png/gif/mp4/mov 格式，单个文件不超过 10MB ",-1)])]),default:l(()=>[e(p,{class:"el-icon--upload"},{default:l(()=>[e(Re)]),_:1}),t[20]||(t[20]=s("div",{class:"el-upload__text"},[m(" 将文件拖到此处，或"),s("em",null,"点击上传")],-1))]),_:1},512)]),_:1}),g.value.length>0?(c(),_("div",gt,[(c(!0),_(D,null,F(g.value,(o,u)=>(c(),_("div",{key:u,class:"file-item"},[s("div",ht,[e(p,{class:"file-icon"},{default:l(()=>[o.type.startsWith("image/")?(c(),S(Z,{key:0})):(c(),S(H,{key:1}))]),_:2},1024),s("span",wt,r(o.name),1),s("span",Vt,r(G(o.size)),1)]),e(f,{size:"small",text:"",onClick:h=>ve(u)},{default:l(()=>[e(p,null,{default:l(()=>[e(ze)]),_:1})]),_:2},1032,["onClick"])]))),128))])):J("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),e(te,{modelValue:W.value,"onUpdate:modelValue":t[13]||(t[13]=o=>W.value=o),title:((le=d.value)==null?void 0:le.title)||((ae=d.value)==null?void 0:ae.original_filename),width:"80%","destroy-on-close":""},{default:l(()=>{var o;return[d.value?(c(),_("div",kt,[s("div",Ct,[d.value.media_type==="photo"?(c(),_("img",{key:0,src:z(d.value.file_path),alt:d.value.title,class:"preview-image",onError:t[11]||(t[11]=u=>u.target.src="/api/placeholder/800/600")},null,40,Ut)):(c(),_("video",{key:1,src:z(d.value.file_path),controls:"",class:"preview-video"},null,8,xt))]),s("div",Mt,[e(Ee,{column:2,border:""},{default:l(()=>[e(C,{label:"文件名"},{default:l(()=>[m(r(d.value.original_filename),1)]),_:1}),e(C,{label:"大小"},{default:l(()=>[m(r(G(d.value.file_size)),1)]),_:1}),e(C,{label:"上传者"},{default:l(()=>{var u;return[m(r((u=d.value.uploader)==null?void 0:u.full_name),1)]}),_:1}),e(C,{label:"上传时间"},{default:l(()=>[m(r(j(d.value.upload_time)),1)]),_:1}),e(C,{label:"所属活动"},{default:l(()=>{var u;return[m(r((u=d.value.activity)==null?void 0:u.title),1)]}),_:1}),e(C,{label:"浏览次数"},{default:l(()=>[m(r(d.value.views_count),1)]),_:1}),e(C,{label:"描述",span:2},{default:l(()=>[m(r(d.value.description||"暂无描述"),1)]),_:1})]),_:1})]),s("div",Bt,[s("h4",null,"评论 ("+r(((o=d.value.comments)==null?void 0:o.length)||0)+")",1),s("div",Dt,[e(E,{modelValue:B.value,"onUpdate:modelValue":t[12]||(t[12]=u=>B.value=u),type:"textarea",rows:2,placeholder:"写下你的评论...",style:{"margin-bottom":"10px"}},null,8,["modelValue"]),e(f,{type:"primary",size:"small",onClick:Ve},{default:l(()=>[...t[22]||(t[22]=[m("发表评论",-1)])]),_:1})]),s("div",Ft,[(c(!0),_(D,null,F(d.value.comments||[],u=>{var h;return c(),_("div",{key:u.id,class:"comment-item"},[e(Ie,{size:32,class:"comment-avatar"},{default:l(()=>{var oe,se;return[m(r((se=(oe=u.author)==null?void 0:oe.full_name)==null?void 0:se.charAt(0)),1)]}),_:2},1024),s("div",Rt,[s("div",$t,[s("span",zt,r((h=u.author)==null?void 0:h.full_name),1),s("span",Lt,r(j(u.created_at)),1)]),s("div",Et,r(u.content),1)])])}),128))])])])):J("",!0)]}),_:1},8,["modelValue","title"])])}}},Yt=Ye(It,[["__scopeId","data-v-58cf9cde"]]);export{Yt as default};
